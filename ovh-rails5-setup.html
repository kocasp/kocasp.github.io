<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Konrad Strojny - portfolio and blog</title>

    <!-- Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/freelancer.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="js/swiffy.js"></script>
    <script src="js/swiffy_objects/swiffy_me.js"></script>
</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#page-top">Konrad Strojny <span style="color:#97be4d">| BLOG</span></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="#portfolio">Portfolio</a>
                    </li>
                    <li class="page-scroll" style="background-color:#0a8fca">
                        <a href="#about">Blog</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#service">Service</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>
        <div class="blue-stripe">
            s
        </div>
    </header>
    <!-- Portfolio Grid Section -->
    <section class="portfolio post">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Rails 5 and Action Cable on OVH server. Complete setup guide</h2>
                    <p>Added 03.01.17</p>
                    <hr class="star-primary star-primary-post">
                </div>
            </div>
            <div class="row article-picture">
                <div class="col-lg-10 col-lg-offset-1 image-responsive">
                    <img src="img/portfolio/ovhrails.jpg" class="img-responsive img-centered" alt="">
                </div>
            </div>
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1">
                    <div id="preview" preview="" debounce="150">

<h3><a id="Setup_ssh_login_for_deploy_2"></a>Setup ssh login for deploy</h3>
<ul>
<li>ssh <a href="mailto:root@xxx.xxx.xxx.xxx">root@xxx.xxx.xxx.xxx</a> providing a password from email</li>
<li>create non-root user <code>useradd -d /home/deploy -m deploy</code> and set a password for him <code>passwd deploy</code></li>
<li>run <code>visudo</code> and add a line below</li>
</ul>
<pre><code>deploy ALL=(ALL) ALL
</code></pre>
<ul>
<li>run <code>vi /etc/ssh/sshd_config</code> and change following lines:</li>
</ul>
<pre><code>Port 4321
PermitRootLogin no
...
AllowUsers deploy
</code></pre>
<ul>
<li>restart ssh</li>
</ul>
<pre><code>service ssh restart
</code></pre>
<ul>
<li>set bash for deploy user</li>
</ul>
<pre><code>chsh -s /bin/bash deploy
</code></pre>
<ul>
<li>log in as deploy via <code>ssh deploy@xxx.xxx.xxx.xxx -p 4321</code> and run:</li>
</ul>
<pre><code>mkdir ~/.ssh
</code></pre>
<ul>
<li>log out from server</li>
<li>being on local, add id_rsa.pub to authorized_keys on the server</li>
</ul>
<pre><code>cat ~/.ssh/id_rsa.pub | ssh deploy@xxx.xxx.xxx.xxx -p 4321 'cat - &gt;&gt; ~/.ssh/authorized_keys'
</code></pre>
<ul>
<li>log in by <code>ssh deploy@xxx.xxx.xxx.xxx -p 4321</code> and change authorized_keys permissions by:</li>
</ul>
<pre><code>sudo chmod 600 ~/.ssh/authorized_keys &amp;&amp; chmod 700 ~/.ssh/
</code></pre>
<ul>
<li>ssh login with <code>deploy@xxx.xxx.xxx.xxx -p 4321</code> is now enabled and secured</li>
</ul>
<h3><a id="Setup_server_environment_40"></a>Setup server environment</h3>
<ul>
<li>prepare your system</li>
</ul>
<pre><code>$ sudo apt-get update
$ sudo apt-get install curl -y
</code></pre>
<ul>
<li>generate ssh key:</li>
</ul>
<pre><code>ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
</code></pre>
<ul>
<li>install ruby using RVM: (in case it fails, run commands mentioned in the error message and try again)</li>
</ul>
<pre><code>$ \curl -L https://get.rvm.io | bash -s stable --ruby
</code></pre>
<ul>
<li>run:</li>
</ul>
<pre><code>source /home/deploy/.rvm/scripts/rvm
</code></pre>
<ul>
<li>install ruby 2.2.2 and set it as default</li>
</ul>
<pre><code>$ rvm install 2.2.2
$ rvm --default use 2.2.2
</code></pre>
<ul>
<li>install bundler:</li>
</ul>
<pre><code>gem install bundler
</code></pre>
<ul>
<li>install Node.js</li>
</ul>
<pre><code>sudo apt-get install -y nodejs
</code></pre>
<h3><a id="Add_server_key_to_the_repository_access_72"></a>Add server key to the repository access</h3>
<ul>
<li>on server, check and copy id_rsa.pub with <code>cat ~/.ssh/id_rsa.pub | pbcopy</code> and add its content to repository (bitbucket/github) deployment keys</li>
</ul>
<h3><a id="Install_and_setup_postgresql_db_on_server_76"></a>Install and setup postgresql db on server:</h3>
<pre><code>$ sudo apt-get install -y postgresql postgresql-contrib
$ sudo apt-get install -y libpq-dev
$ sudo apt-get clean
</code></pre>
<ul>
<li>on server: create user for app (replace sampleuser with your username and password with your password)</li>
</ul>
<pre><code>$ sudo -u postgres psql -c "CREATE USER sampleuser WITH PASSWORD 'password' CREATEDB;"
$ sudo -u postgres psql -c "CREATE DATABASE app_production;"
$ sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE app_production to sampleuser;"
$ sudo -u postgres psql -c "ALTER USER sampleuser WITH SUPERUSER;"
</code></pre>
<ul>
<li>create database.yml in shared directory</li>
</ul>
<pre><code>$ mkdir -p ~/apps/literki/shared/pids
$ mkdir -p ~/apps/literki/shared/log
$ mkdir -p ~/apps/literki/releases
$ mkdir -p ~/apps/literki/shared/config
$ cd ~/apps/literki/shared/config
$ vi database.yml
</code></pre>
<p>paste following content in vi editor:</p>
<pre><code>production:
  adapter:  postgresql
  host:     localhost
  encoding: unicode
  database: app_production
  username: sampleuser
  password: password
</code></pre>
<ul>
<li>create application.yml in shared directory. Being still in shared/config folder:</li>
</ul>
<pre><code>$ touch application.yml
</code></pre>
<h3><a id="Install_nginx_server_113"></a>Install nginx server</h3>
<ul>
<li>run</li>
</ul>
<pre><code>sudo apt-get install -y nginx
</code></pre>
<ul>
<li>next run</li>
</ul>
<pre><code>sudo vi /etc/nginx/sites-enabled/default
</code></pre>
<p>erase all fily by pressing ESC then type :1,$d and ENTER<br>
and paste the following:</p>
<pre><code>#this should be placed under /etc/nginx/sites-enabled/default
#remember about changing xxx.xxx.xxx.xxx to IP address and updating app paths

upstream unicorn {
  server unix:/tmp/unicorn.spui.sock fail_timeout=0;
}

server {
  listen 80 default deferred;
  server_name xxx.xxx.xxx.xxx;
  root /home/deploy/apps/literki/current/public;
  error_log  /etc/nginx/nginx_error.log  warn;

  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  location /cable {
     proxy_pass http://unicorn/cable;
     proxy_http_version 1.1;
     proxy_set_header Upgrade websocket;
     proxy_set_header Connection Upgrade;
     proxy_set_header X-Real-IP $remote_addr;
     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   }

  location ~ ^/(robots.txt|sitemap.xml.gz)/ {
    root /home/deploy/apps/literki/current/public;
  }

  try_files $uri/index.html $uri @unicorn;
  location @unicorn {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://unicorn;
  }

  error_page 500 502 503 504 /500.html;
  client_max_body_size 4G;
  keepalive_timeout 10;
}


</code></pre>
<ul>
<li>run puma from current directory:</li>
</ul>
<pre><code>bundle exec puma -e production -b unix:///home/deploy/apps/letters/shared/tmp/sockets/letters-puma.sock --daemon
</code></pre>
<ul>
<li>install redis server and run as daemon</li>
</ul>
<pre><code>$ sudo apt-get install redis-server
$ redis-server --daemonize yes
</code></pre>
<ul>
<li>restart nginx with:</li>
</ul>
<pre><code>sudo service nginx restart
</code></pre>
<ul>
<li>install git</li>
</ul>
<pre><code>sudo apt-get install git
</code></pre>
</div>
                </div>
            </div>
        </div>
    </section>


    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4">
                        <h3>Location</h3>
                        <p>3481 Melrose Place<br>Beverly Hills, CA 90210</p>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Around the Web</h3>
                        <ul class="list-inline">
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-facebook"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-google-plus"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-twitter"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-linkedin"></i></a>
                            </li>
                            <li>
                                <a href="#" class="btn-social btn-outline"><i class="fa fa-fw fa-dribbble"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>About Freelancer</h3>
                        <p>Freelance is a free to use, open source Bootstrap theme created by <a href="http://startbootstrap.com">Start Bootstrap</a>.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; Your Website 2014
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-top page-scroll visible-xs visble-sm">
        <a class="btn btn-primary" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/freelancer.js"></script>
    <script>
    </script>
</body>

</html>
